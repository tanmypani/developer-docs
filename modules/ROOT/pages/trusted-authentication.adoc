= Trusted authentication
:toc: true
:toclevels: 1

:page-title: trusted authentication
:page-pageid: trusted-auth
:page-description: You can configure support for token-based authentication service on ThoughtSpot.

Trusted authentication allows a web application to authenticate a user to a ThoughtSpot instance using *login tokens* requested from a ThoughtSpot instance. 

It is the most seamless method of single sign-on (SSO) available to embed ThoughtSpot, but the actual *authentication* of the user is performed by a *token request service* that must be developed and added to the web application.


== Cookie-based vs. cookieless authentication
The trusted authentication method supports cookie-based and cookieless authentication. 

In cookie-based authentication, the login token is only necessary during the login process, after which any request to ThoughtSpot will include session cookies that identify the signed-in user.

In cookieless authentication, the bearer token issued by the authentication server is used to authenticate API requests to ThoughtSpot.

== Overview

*Securely requesting the login token* requires passing authentication details from the embedding application securely to a *token request service* with access to the `secret_key` for the ThoughtSpot instance and ThoughtSpot admin user's credentials.

The *token request service* is part of the web application and must be developed by your team.

The process for trusted authentication is as follows:

 1. The Visual Embed SDK, loaded within the embedded application page, calls the `init()` function with the correct set of parameters to request a *login token*.
 2. The request for the *login token* securely provides the username and any additional details to the *authenticator service*.
 3. The *token request service* verifies and parses the username and other details, and issues REST API commands to ThoughtSpot, such as requesting a *login token* for the provided username.
 4. The *token request service* returns the *login token* to the browser and the Visual Embed SDK.
 5. The Visual Embed SDK issues requests to establish a ThoughtSpot session in the browser.

The following figure illustrates the trusted authentication workflow with session cookies and REST API calls to v1 endpoints:

image::./images/trusted-auth-workflow.png[Trusted Authentication Workflow]


[#trusted-auth-sdk]
== Visual Embed SDK / front-end

The Visual Embed SDK automates the login token request, and the login process using the token obtained from ThoughtSpot.

The request to the *authenticator service* is defined in the `init()` function of the Visual Embed SDK. When `init()` is called, the SDK checks if there is an existing ThoughtSpot session for the instance in the browser. If not, it will request a *login token* from either the `authEndpoint` URL or the `getAuthToken` callback function.

You can use cookie-based or cookieless authentication as per your deployment needs. If you are embedding ThoughtSpot content in an app that is not in the same domain as your ThoughtSpot instance, and your web browser blocks third-party cookies, use cookieless authentication.

For more information, see xref:embed-authentication.adoc#trusted-auth-embed[Embed user authentication page].

=== Secure the authentication details request
For the request to the *authenticator service* to be secure, the user in the browser cannot modify the request or make their own valid request to the *authenticator service*.

How your particular application can most easily securely request the *login token* is up to you, but how you choose to send the message will constrain your choice between `authEndpoint` or `getAuthToken`.

* If you choose `AuthType.TrustedAuthToken` and `authEndpoint`, a GET request is made directly to the provided URL. The authentication details must be included by the browser in this automated GET request, typically in the cookies. Cookies are not sent across domains (only to sub-domains), so your *authenticator service* must be *hosted in the same domain* as the embedding application.

* If you choose `AuthType.TrustedAuthTokenCookieless`, a bearer token is issued for the given username. This token is stored in the app's memory and used for maintaining subsequent user sessions. You can use this authentication type if your *authenticator service* is not *hosted in the same domain* as the embedding application, and your browser restricts using third-party cookies.

* When using `getAuthToken`, you specify a function that returns a Promise that resolves with the *login token*. Within the callback function, you can define the request to the *authenticator service* with far greater control than the automated `GET` request to a URL used by the `authEndpoint` option. `getAuthToken` is the preferred method for production deployments unless your *authenticator service* is implemented within the existing API endpoints of your application and a simple GET request provides the necessary authentication details as shown here.

+
The following example shows a callback function with a custom request using link:https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch[Fetch, window=_blank], which returns a Promise. You can also use link:https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest[XHR, window=_blank] and build the link:https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise[Promise, window=_blank] manually.

+
[source,JavaScript]
----
init({
    thoughtSpotHost: tsURL,
    authType:  AuthType.TrustedAuthToken,
    getAuthToken: getAuthToken,
    username: username
  });

function async getAuthToken {
  const tokenURL = tokenServiceURL + "/gettoken/";
  console.log("calling token server at " + tokenURL);

  const timeoutSecs = 5 * 1000; // seconds to milliseconds

  const response = await timeout(timeoutSecs, fetch(
    tokenURL,
    {
      method: 'POST',
      mode: 'cors',
      cache: 'no-cache',
      headers: {
        'Content-Type': "text/plain",
        'X-TS-Auth-Token': tsAuthJWT
      },
      credentials: 'include'
    }
  ))

  // Have to return a promise for the auth SDK.
  //console.log(await response.text());
  return response.text()
}
----

==== Cookie-based authentication examples

[source,JavaScript]
----
init({
    thoughtSpotHost: "https://<hostname>:<port>",
    authType: AuthType.TrustedAuthToken,
    username: "<username>",
    authEndpoint: "https://authenticator-server:<port>/endpoint",
});
----

[source,JavaScript]
----
init({
    thoughtSpotHost: <ThoughtSPot-Host-URL>
    authType: AuthType.TrustedAuthToken,
    username: "<username>",
    getAuthToken: () => {
        return fetch('https://my-backend.app/ts-token')
            .then((response) => response.json())
            .then((data) => data.token);
 });
----

==== Cookieless authentication examples

[source,JavaScript]
----
init({
    thoughtSpotHost: "https://<hostname>:<port>",
    authType: AuthType.TrustedAuthTokenCookieless,
    username: "<username>",
    authEndpoint: "https://authenticator-server:<port>/endpoint",
});
----

[source,JavaScript]
----
init({
    thoughtSpotHost: <ThoughtSPot-Host-URL>
    authType: AuthType.TrustedAuthTokenCookieless,
    getAuthToken: () => {
        return fetch('https://my-backend.app/ts-token')
            .then((response) => response.json())
            .then((data) => data.token);
 });
----




[#login-token]
== Login token expiration
Login tokens from the V1 and V2 REST APIs have different expiration rules.

V1 login tokens only work for cookie-based Trusted Authentication, while the V2 tokens can be used for cookie-based or cookieless Trusted Auth. 

=== V2 token
The V2 REST API token is a standard OAuth 2.0 token that encodes several properties with in the token, most notably the username and the expiration time.

The validity time of the token is never extended by any activity, so a new token must be requested after the intiial token passes its expiration time.

The V2 token REST API endpoint has a request argument called `validity_time_in_sec` that defaults to 300 seconds (5 minutes). 

For cookie-based Trusted Authentication, you may want to shorten the `validity_time_in_sec` to less than one minute, since the token is only used once and then there is a long-lived cookie-based session. The ThoughtSpot session end time will extend naturally as the user interacts with ThoughtSpot.

For cookieless Trusted Authentication, you will want to request the token with a longer validity, possibly 20 or 30 minutes or more. 


=== V1 token
The V1 REST API login token is a proprietary token format that cannot be decoded or used for any purpose other than to create a ThoughtSpot session.

V1 tokens stay valid for a length of time based on the following rules:

* A token stays valid indefinitely until another token for any user is generated.
* When a new token is generated using the same `secret_key`, the previous token will expire after five minutes.
* When a new `secret_key` is generated for the ThoughtSpot server and the first new login token is obtained using the new `secret_key`, all tokens generated using the previous `secret_key` become invalid.
* If users make multiple attempts to log in to ThoughtSpot using an invalid or expired token, they may get locked out of their accounts.

To set a consistent five-minute expiration time, you can generate a second token to start the expiration clock for the previous login token that is sent to the user's browser.

[NOTE]
====
On multi-tenant clusters with Orgs, users must use the Org-specific tokens when switching between Orgs.
====

== Troubleshoot trusted authentication

[NOTE]
====
When implementing trusted authentication with session cookies, check if your browser allows third-party cookies. Chrome now blocks third-party cookies in Incognito mode by default, while Safari blocks them by default even in standard mode. If your Web browser rejects third-party cookies, the embedded content will be blocked. To workaround this issue, you can enable cookieless authentication (`AuthType.TrustedAuthTokenCookieless`) in the SDK.
====

== Implement without Visual Embed SDK
The Visual Embed SDK handles the final REST API request to create the session, but it is possible to perform the login using xref:session-api.adoc#session-loginToken[/session/login/token] or the xref:rest-api-v2-reference.adoc#_authentication[ REST API v2.0 token access endpoints]. For more information, see xref:api-auth-session.adoc#_authenticate_and_log_in_with_a_token_trusted_authentication[REST API v1 authentication] and xref:authentication.adoc#trusted-auth-v2[REST API v2.0 authentication].

[NOTE]
====
The REST API v1 `session/login/token` and v2.0 token access endpoints are not used for establishing a REST API session for backend processes or administration scripts. Use the xref:session-api.adoc#session-login[/session/login] endpoint with `username` and `password` to create a REST API session.

////
* The REST API v2.0 allows using bearer or trusted authentication tokens. The authentication tokens obtained from REST API separate from the REST API v1 login token.
////
====

////
REST API clients can make a `GET` or `POST` API call to the xref:session-api.adoc#session-loginToken[tspublic/v1/session/login/token] API endpoint to log in a user. Note that the `GET` call to the `tspublic/v1/session/login/token` endpoint must include a fully-encoded URL with the authentication token and resource endpoint in the request URL.

----
https://{ThoughtSpot-Host}/callosum/v1/tspublic/v1/session/login/token?username=tsUser&auth_token=JHNoaXJvMSRTSEEtMjU2JDUwMDAwMCRPMFA2S0ZlNm51Qlo4NFBlZUppdzZ3PT0kMnJKaSswSHN6Yy96ZGxqdXUwd1dXZkovNVlHUW40d3FLMVdBT3hYVVgxaz0&redirect_url=https://<redirect-domain>/?authtoken=<auth_token>&embedApp=true&primaryNavHidden=true#/embed/viz/<Liveboard_id>/<visualization_id>
----

ThoughtSpot recommends sending the authentication attributes in a `POST` request body instead of a `GET` call.

----
curl -X POST \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Accept: application/json' \
-d 'username=tsuser&auth_token=JHNoaXJvMSRTSEEtMjU2JDUwMDAwMCRtL3dWcVo2ZTdWTzYvemdXN1ZoaTh3PT0kdmlyNnQ4NHlwYXlqNFV4VzBpRlNYbmQ1bzk5T1RFK2NVZy9ZRUhvUEkvST0&redirect_url=https://<ThoughtSpot-Host>/?embedV2=true#/pinboard/7a9a6715-e154-431b-baaf-7b58246c13dd%2F' \
'https://<ThoughtSpot-Host>/callosum/v1/tspublic/v1/session/login/token'
----

The API request must include the following attributes:

* `username` +
_String_. The `username` of the user requesting access to the embedded ThoughtSpot content.

* `auth_token` +
_String_. The authentication token obtained for the user.

* `redirect_url` +
_String_. The URL to which the user is redirected after successful authentication.

+
----
https://<redirect-domain>/?embedV2=true#/pinboard/7a9a6715-e154-431b-baaf-7b58246c13dd%2F
----
////

== Additional resources

* A simple Python Flask implementation of an Authenticator Service is available in the link:https://github.com/thoughtspot/ts_everywhere_resources/tree/master/examples/token_auth[ts_everywhere_resources GitHub repository, window=_blank].  +
 The token_auth directory contains a link:https://github.com/thoughtspot/ts_everywhere_resources/blob/master/examples/token_auth/trusted_auth_tester.html[trusted_auth_tester.html, window=_blank] page to help verify each step of the trusted authentication process.
* link:https://github.com/thoughtspot/node-token-auth-server-example[https://github.com/thoughtspot/node-token-auth-server-example, window=_blank]
* link:https://github.com/thoughtspot/big-react-demo[React code samples, window=_blank]
